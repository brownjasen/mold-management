<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>模具精益生产管理系统</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 20px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .header h1 { font-size: 28px; }
    .btn-primary {
      padding: 10px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-primary:hover { background: #45a049; }
    .search-box {
      margin-bottom: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
    }
    .search-box input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    table {
      width: 100%;
      background: white;
      border-collapse: collapse;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    thead { background: #f5f5f5; }
    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    tbody tr:hover { background: #f9f9f9; }
    .progress-bar {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .progress {
      flex: 1;
      height: 6px;
      background: #ddd;
      border-radius: 3px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50, #45a049);
      width: 0%;
      transition: width 0.3s;
    }
    .btn-small {
      padding: 6px 12px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-right: 5px;
    }
    .btn-small:hover { background: #0b7dda; }
    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    .status.pending { background: #ffebee; color: #c62828; }
    .status.in_progress { background: #fff3e0; color: #e65100; }
    .status.completed { background: #e8f5e9; color: #2e7d32; }
    .loading {
      text-align: center;
      padding: 40px;
      font-size: 16px;
    }
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 8px;
      min-width: 400px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .btn-secondary {
      flex: 1;
      padding: 10px;
      background: #ddd;
      color: #333;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>模具精益生产管理系统</h1>
      <button class="btn-primary" onclick="openCreateModal()">+ 新建模具订单</button>
    </div>

    <div class="search-box">
      <input type="text" id="searchInput" placeholder="搜索模具编号..." onkeyup="filterMolds()">
    </div>

    <div id="errorMsg" class="error" style="display: none;"></div>
    <div id="loadingMsg" class="loading" style="display: none;">正在加载数据...</div>

    <table>
      <thead>
        <tr>
          <th>模具编号</th>
          <th>下单时间</th>
          <th>生产进度</th>
          <th>状态</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="moldBody">
      </tbody>
    </table>
  </div>

  <!-- 创建模具弹窗 -->
  <div id="createModal" class="modal">
    <div class="modal-content">
      <h2>新建模具订单</h2>
      <div class="form-group">
        <label>模具编号</label>
        <input type="text" id="moldNumber" placeholder="如：SC25-01">
      </div>
      <div class="form-group">
        <label>下单时间</label>
        <input type="datetime-local" id="orderTime">
      </div>
      <div class="modal-buttons">
        <button class="btn-primary" onclick="saveMold()">保存</button>
        <button class="btn-secondary" onclick="closeCreateModal()">取消</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:5000/api';
    let allMolds = [];

    // 页面加载时获取数据
    window.onload = () => {
      loadMolds();
    };

    function showError(msg) {
      const errorDiv = document.getElementById('errorMsg');
      errorDiv.textContent = msg;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    function showLoading(show = true) {
      document.getElementById('loadingMsg').style.display = show ? 'block' : 'none';
    }

    function loadMolds() {
      showLoading(true);
      fetch(`${API_URL}/molds/list`)
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return res.json();
        })
        .then(data => {
          showLoading(false);
          if (data.success && data.data) {
            allMolds = data.data;
            renderTable();
          } else {
            showError('获取数据失败：' + (data.error || '未知错误'));
          }
        })
        .catch(err => {
          showLoading(false);
          showError('连接后端失败：' + err.message + '\n请确保后端服务已启动 (npm start)');
          console.error('API Error:', err);
        });
    }

    function renderTable() {
      const tbody = document.getElementById('moldBody');
      if (allMolds.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">暂无数据，点击上方按钮创建模具订单</td></tr>';
        return;
      }

      tbody.innerHTML = allMolds.map(mold => `
        <tr onclick="goToDetail('${mold._id}')">
          <td><strong>${mold.moldNumber}</strong></td>
          <td>${new Date(mold.orderTime).toLocaleDateString('zh-CN')}</td>
          <td>
            <div class="progress-bar">
              <div class="progress">
                <div class="progress-fill" style="width: ${mold.overallProgress}%"></div>
              </div>
              <span><strong>${mold.overallProgress}%</strong></span>
            </div>
          </td>
          <td>
            <span class="status ${mold.status}">
              ${getStatusLabel(mold.status)}
            </span>
          </td>
          <td>
            <button class="btn-small" onclick="event.stopPropagation(); alert('编辑功能 - 开发中')">编辑</button>
            <button class="btn-small" onclick="event.stopPropagation(); prioritizeMold('${mold._id}')">加急</button>
          </td>
        </tr>
      `).join('');
    }

    function filterMolds() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const filtered = allMolds.filter(m => m.moldNumber.toLowerCase().includes(search));
      const tbody = document.getElementById('moldBody');
      
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">未找到匹配的模具</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(mold => `
        <tr onclick="goToDetail('${mold._id}')">
          <td><strong>${mold.moldNumber}</strong></td>
          <td>${new Date(mold.orderTime).toLocaleDateString('zh-CN')}</td>
          <td>
            <div class="progress-bar">
              <div class="progress">
                <div class="progress-fill" style="width: ${mold.overallProgress}%"></div>
              </div>
              <span><strong>${mold.overallProgress}%</strong></span>
            </div>
          </td>
          <td>
            <span class="status ${mold.status}">
              ${getStatusLabel(mold.status)}
            </span>
          </td>
          <td>
            <button class="btn-small" onclick="event.stopPropagation(); alert('编辑功能 - 开发中')">编辑</button>
            <button class="btn-small" onclick="event.stopPropagation(); prioritizeMold('${mold._id}')">加急</button>
          </td>
        </tr>
      `).join('');
    }

    function goToDetail(moldId) {
      window.location.href = `detail.html?id=${moldId}`;
    }

    function getStatusLabel(status) {
      const labels = {
        'pending': '等待中',
        'in_progress': '生产中',
        'completed': '已完成',
        'repair': '返修中'
      };
      return labels[status] || status;
    }

    function openCreateModal() {
      document.getElementById('createModal').classList.add('show');
      // 设置默认时间为当前时间
      const now = new Date();
      const iso = now.toISOString().slice(0, 16);
      document.getElementById('orderTime').value = iso;
    }

    function closeCreateModal() {
      document.getElementById('createModal').classList.remove('show');
      document.getElementById('moldNumber').value = '';
    }

    function saveMold() {
      const moldNumber = document.getElementById('moldNumber').value.trim();
      const orderTime = document.getElementById('orderTime').value;

      if (!moldNumber) {
        alert('请输入模具编号');
        return;
      }

      if (!orderTime) {
        alert('请选择下单时间');
        return;
      }

      fetch(`${API_URL}/molds/create`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          moldNumber,
          orderTime: new Date(orderTime).toISOString()
        })
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert('创建成功！');
            closeCreateModal();
            loadMolds();
          } else {
            alert('创建失败：' + data.error);
          }
        })
        .catch(err => {
          alert('错误：' + err.message);
        });
    }

    function prioritizeMold(moldId) {
      fetch(`${API_URL}/molds/reprioritize`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          moldId,
          newQueue: 0
        })
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert('已设置为加急！');
            loadMolds();
          } else {
            alert('操作失败：' + data.error);
          }
        })
        .catch(err => {
          alert('错误：' + err.message);
        });
    }
  </script>
</body>
</html>
